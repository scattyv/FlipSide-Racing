#tag WindowBegin Window selectRacerWindow   BackColor       =   16777215   Backdrop        =   ""   CloseButton     =   True   Composite       =   False   Frame           =   0   FullScreen      =   False   HasBackColor    =   False   Height          =   184   ImplicitInstance=   True   LiveResize      =   True   MacProcID       =   0   MaxHeight       =   32000   MaximizeButton  =   False   MaxWidth        =   32000   MenuBar         =   ""   MenuBarVisible  =   True   MinHeight       =   64   MinimizeButton  =   True   MinWidth        =   64   Placement       =   0   Resizeable      =   True   Title           =   "Please Select Racer(s)"   Visible         =   True   Width           =   600   Begin ListBox RacerListBox      AutoDeactivate  =   True      AutoHideScrollbars=   True      Bold            =   False      Border          =   True      ColumnCount     =   8      ColumnsResizable=   True      ColumnWidths    =   ""      DataField       =   ""      DataSource      =   ""      DefaultRowHeight=   -1      Enabled         =   True      EnableDrag      =   ""      EnableDragReorder=   ""      GridLinesHorizontal=   1      GridLinesVertical=   2      HasHeading      =   True      HeadingIndex    =   -1      Height          =   116      HelpTag         =   ""      Hierarchical    =   False      Index           =   -2147483648      InitialParent   =   ""      InitialValue    =   "Name	Class	Chassis	Make	Model	Motor	Scale	UID"      Italic          =   ""      Left            =   20      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   True      LockTop         =   True      RequiresSelection=   True      Scope           =   0      ScrollbarHorizontal=   False      ScrollBarVertical=   True      SelectionType   =   1      TabIndex        =   2      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   "#textsize12"      Top             =   14      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   560      _ScrollOffset   =   0      _ScrollWidth    =   -1   End   Begin pushbutton loadRacersButton      AutoDeactivate  =   True      Bold            =   False      Cancel          =   ""      Caption         =   "Load"      Default         =   True      Enabled         =   True      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   False      Left            =   492      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   2      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   0      Top             =   142      Underline       =   False      Visible         =   True      Width           =   88   End   Begin pushbutton cancelButton      AutoDeactivate  =   True      Bold            =   False      Cancel          =   True      Caption         =   "Cancel"      Default         =   ""      Enabled         =   True      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   False      Left            =   392      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   2      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   0      Top             =   142      Underline       =   False      Visible         =   True      Width           =   88   EndEnd#tag EndWindow#tag WindowCode	#tag Event		Sub Open()		  //Sort by name when opened		  if RacerListBox<>nil then		    If RacerListBox.ListCount > 0 then		      RacerListBox.ColumnSortDirection(0) = ListBox.SortAscending		      RacerListBox.SortedColumn=0		      RacerListBox.Sort		    end if		  end if		End Sub	#tag EndEvent	#tag Method, Flags = &h0		Sub Constructor(index as integer)		  dim rs as RecordSet		  dim names(-1) as string		  dim i as Integer		  dim query as string		  		  initiatingSlot=index		  for i=0 to UBound(G_Preferences.theRaceObject.racers)		    if G_Preferences.theRaceObject.racers(i).Active=true then		      names.Append G_Preferences.theRaceObject.racers(i).theName		    end if//get a list of the names of all active racer, we don't want to select those as possible selection choices		  next		  		  query = "SELECT * FROM racer_table"		  if UBound(names)>-1 then		    query = query+" WHERE "		    for i=0 to UBound(names)		      if i=UBound(names) then		        query=query+"name<>'"+names(i)+"'"		      else		        query=query+"name<>'"+names(i)+"'"+" AND "		      end if		    next		  end if//the query should not only select 'inactive' racers that are selectable because they aren't already in a slot		  		  		  rs = G_Database.SQLSelect(query)		  if rs<>nil and rs.RecordCount<>0 then		    while not rs.EOF		      RacerListBox.AddRow ""		      RacerListBox.cell(RacerListBox.ListCount-1,0)=rs.Field("name").StringValue		      RacerListBox.cell(RacerListBox.ListCount-1,1)=rs.Field("class").StringValue		      RacerListBox.cell(RacerListBox.ListCount-1,2)=rs.Field("chassis").StringValue		      RacerListBox.cell(RacerListBox.ListCount-1,3)=rs.Field("make").StringValue		      RacerListBox.cell(RacerListBox.ListCount-1,4)=rs.Field("model").StringValue		      RacerListBox.cell(RacerListBox.ListCount-1,5)=rs.Field("motor").StringValue		      RacerListBox.cell(RacerListBox.ListCount-1,6)=rs.Field("scale").StringValue		      RacerListBox.cell(RacerListBox.ListCount-1,7)=rs.Field("uid").StringValue		      rs.MoveNext		    wend		  else		    //MsgBox "There are no more racers to select from, please create another racer if you would like to add more to the race."		    self.Close		  end if		  // Calling the overridden superclass constructor.		  Super.Window		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub loadSelectedRacers(theListBox as listbox)		  dim i,k as Integer		  dim indexer as Integer		  dim clear as Boolean = false		  dim selectedCount as Integer = -1		  dim pass as Boolean		  		  If theListBox.listIndex = -1 then		    MsgBox "You must select at least one racer to load into the slot."		    Return		  End if		  		  //We know the initiatingSlot, now we just determine how many selections there are and what to do with them		  		  for i=0 to theListBox.ListCount-1		    if theListBox.Selected(i)=true then		      selectedCount=selectedCount+1		      if selectedCount<G_Preferences.maxRacers then		        indexer = initiatingSlot+selectedCount		        		        while clear=false		          if indexer> G_Preferences.maxRacers - 1 then//this insures no out of bounds exceptions, and so it fills in the correct empty slots		            indexer=indexer-G_Preferences.maxRacers//this should cause cycles of 0 to 7 correctly, -8 cause of the addition from selectedCount		          else		            Clear=true		          end if		        wend		        Clear=false		        		        //Logic to only fill slots that are empty		        while mainWindow.slotButton(indexer).Caption="Remove (-)"		          if indexer>G_Preferences.maxRacers - 2 then		            //MsgBox "Not enough free slots"		            return		          else		            indexer = indexer + 1		          end if		        wend		        		        		        //Now we need to know what 'race car' that line in the Listbox was refering to		        for k=0 to UBound(G_Preferences.theRaceObject.racers)		          if theListBox.cell(i,0)=G_Preferences.theRaceObject.racers(k).theName and theListBox.cell(i,7)=G_Preferences.theRaceObject.racers(k).UID then//TODO: it will need to do checks by ID later not name or errors will occur		            mainWindow.M_Slots(indexer)=G_Preferences.theRaceObject.racers(k)//the correct racer info is now aligned to the correct slot (probably by reference at that)		            mainWindow.slotButton(indexer).caption="Remove (-)"		            mainWindow.slotText(indexer).Text="Slot "+str(indexer+1)+": "+G_Preferences.theRaceObject.racers(k).theName+" (In this Race!)"		            		            if mainWindow.M_RaceActive = true then		              mainWindow.slotButton(indexer).Enabled = False		            end if		            		            //Apply color to racer for use on main screen		            G_Preferences.theRaceObject.racers(k).textColor=mainWindow.slotText(indexer).TextColor		            		            mainWindow.slotPicture(indexer).backdrop=G_Preferences.theRaceObject.racers(k).theImage		            If G_Preferences.theRaceObject.Racers(k).theImageMask <> Nil then		              mainWindow.slotPicture(indexer).Backdrop.mask.graphics.drawpicture G_Preferences.theRaceObject.racers(k).theImageMask,0,0		            end if		            G_Preferences.theRaceObject.racers(k).Active=true//it's now active since it's been added.  This shoudn't be allowed to be selected from the list now again~		            		            //For adding mid game make sure information is reset...		            //G_Preferences.theRaceObject.racers(k).timeSinceLastCheck=Microseconds//just in case you just added the racer, this will simulate the 'initial time', so it gets the first lap time correct.  TODO: change later?		            //		            //Use the race start time to determine this		            G_Preferences.theRaceObject.racers(k).timeSinceLastCheck=mainWindow.M_StartTime		            		            redim G_Preferences.theRaceObject.racers(k).lapTimes(-1)//this can happen if a new racer was added mid-game (erase prior data in 0)		            redim G_Preferences.theRaceObject.racers(k).lapCounts(-1)		            redim G_Preferences.theRaceObject.racers(k).timeAtLap(-1)		            redim G_Preferences.theRaceObject.racers(k).lapTimes(0)//(set the first position always to 0)		            redim G_Preferences.theRaceObject.racers(k).lapCounts(0)		            redim G_Preferences.theRaceObject.racers(k).timeAtLap(0)		            		            G_Preferences.theRaceObject.racers(k).lapCount=0//to reset it		            G_Preferences.theRaceObject.racers(k).best_time=9999		            G_Preferences.theRaceObject.racers(k).Pace=0		            G_Preferences.theRaceObject.racers(k).lagTime=0		            G_Preferences.theRaceObject.racers(k).lastLapTime=0		            G_Preferences.theRaceObject.racers(k).lapsLeading=0		            G_Preferences.theRaceObject.racers(k).firstPass=0		            		            		            //Without this line it won't know to anime this new racer correctly		            G_Preferences.theRaceObject.activeRacers.Append G_Preferences.theRaceObject.racers(k)//this will add to the currently active racers in the 'race' right now.  At the end of a race this will be nil~		            G_Preferences.theRaceObject.activeUIDs.Append G_Preferences.theRaceObject.racers(k).UID		            		            //It's also required that database references are stored now, no removing once it's in!		            		            if G_Preferences.theRaceObject.RaceType <> "Free Play" then		              pass = G_Preferences.theRaceObject.StoreRacerToDatabase(G_Preferences.theRaceObject.racers(k).UID)		              if pass=false then		                MsgBox "An Error Occured while trying to store just the single racer to the database system, report this to admin"		              end if		            else		              pass = true		            end if		            mainWindow.AnimateRaceScreen()//to reflect changes to the slots~		            exit//we found what we wanted so exit		          end if		        next		        		      end if//end of making sure you only count 8 selected items, else it may make racers active that aren't!		    end if//end of if selected		  next		  self.Close//close the window now		End Sub	#tag EndMethod	#tag Note, Name = LICENSE		Copyright 2008 Jeremy Auten				This file is part of Flip Side Racing Software.				Flip Side Racing Software is free software: you can redistribute it and/or modify		it under the terms of the GNU General Public License as published by		the Free Software Foundation, either version 3 of the License, or		(at your option) any later version.				Flip Side Racing Software is distributed in the hope that it will be useful,		but WITHOUT ANY WARRANTY; without even the implied warranty of		MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the		GNU General Public License for more details.				You should have received a copy of the GNU General Public License		along with Flip Side Racing Software.  If not, see <http://www.gnu.org/licenses/>.	#tag EndNote	#tag Property, Flags = &h0		#tag Note			//The slot you clicked 'Add' From		#tag EndNote		initiatingSlot As Integer	#tag EndProperty#tag EndWindowCode#tag Events RacerListBox	#tag Event		Sub Change()		  '// Display information about selected racer		  'Dim i as Integer		  '		  '// If record is not selected then we do not have anything else to do		  'If Me.listIndex = -1 then		  'Return		  'End if		  '		  ''// Clear the fields		  ''ClearEditRacerFields		  '		  '// Get info from record		  'M_selectedRecordSet = G_database.SQLSelect("SELECT * FROM racer_table WHERE " + "name == '" + Me.Cell(Me.listindex,0) + "'")		  '		  '// Populate edit racer feilds with results from previous query using method		  'PopulateEditRacerInfo()//to reflect the change it will fill the editracer info with the item that is selected~		  		  		  		  		  		End Sub	#tag EndEvent#tag EndEvents#tag Events loadRacersButton	#tag Event		Sub Action()		  loadSelectedRacers(RacerListBox)		End Sub	#tag EndEvent#tag EndEvents#tag Events cancelButton	#tag Event		Sub Action()		  self.Hide		End Sub	#tag EndEvent#tag EndEvents