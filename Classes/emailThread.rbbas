#tag ClassProtected Class emailThreadInherits Thread	#tag Event		Sub Run()		  me.Priority = 1		  dim socket as new SMTPSocket		  dim securesocket as new SMTPSecureSocket		  dim mail as EmailMessage		  //Make sure we have settings		  if emailServer <> "" and emailUsername <> "" and emailPassword <> "" and emailPort <> 0 then		    //Process the queue, if we have anything		    While UBound(EmailMessages) > -1		      for i as integer = 0 to UBound(EmailMessages)		        mail = EmailMessages.Pop		        		        if emailEncrypt = false then		          socket.Address = sanitizeString(emailServer)		          socket.Port = emailPort		          socket.Username = sanitizeString(emailUsername)		          socket.Password = emailPassword		          socket.Messages.Append mail		        else		          securesocket.Address = sanitizeString(emailServer)		          securesocket.Port = emailPort		          securesocket.Username = sanitizeString(emailUsername)		          securesocket.Password = emailPassword		          securesocket.Messages.Append mail		        end if		      next		      		      //Now send the queue		      if emailEncrypt = false then		        Socket.SendMail		      else		        securesocket.SendMail		      end if		      		    wend		    		  end if		  		  		End Sub	#tag EndEvent	#tag Method, Flags = &h0		Sub newMessage(subject as string, body as string, attachmentpath as string, toaddress as string)		  //First update our settings		  updateSettings		  		  dim mail as EmailMessage		  		  mail = New EmailMessage		  if emailFrom <> "" then		    mail.FromAddress=sanitizeString(emailFrom)		  else		    mail.FromAddress=sanitizeString(emailUsername)		  end if		  		  mail.Subject = sanitizeString(subject)		  mail.BodyHTML = body		  mail.Headers.AppendHeader "X-Mailer","Flip Side Racing SMTP"		  mail.AddRecipient sanitizeString(toaddress)		  		  //Attachment is not used yet, need a way to set the content-id so that it will be displayed properly in email		  //dim file as EmailAttachment		  //file = New EmailAttachment		  //file.LoadFromFile GetFolderItem(attachmentpath)		  //mail.Attachments.Append file		  		  		  EmailMessages.Append(mail)		End Sub	#tag EndMethod	#tag Method, Flags = &h21		Private Function sanitizeString(source as String) As String		  for i as integer = 0 to 31		    source = ReplaceAll(source, Chr(i), "")		    		  next		  		  return source		End Function	#tag EndMethod	#tag Method, Flags = &h21		Private Sub updateSettings()		  emailEncrypt = G_Preferences.readB("emailEncrypt")		  emailPassword = G_Preferences.readS("emailPassword")		  emailPort = G_Preferences.readI("emailPort")		  emailServer = G_Preferences.readS("emailServer")		  emailUsername = G_Preferences.readS("emailUsername")		  		  if G_Preferences.readS("emailFrom") <> "" then		    emailFrom = G_Preferences.readS("emailFrom")		  else		    emailFrom = "racereport@" + emailServer		    		  end if		End Sub	#tag EndMethod	#tag Property, Flags = &h0		emailEncrypt As Boolean = false	#tag EndProperty	#tag Property, Flags = &h0		emailFrom As string	#tag EndProperty	#tag Property, Flags = &h0		emailMessages() As EmailMessage	#tag EndProperty	#tag Property, Flags = &h0		emailPassword As string	#tag EndProperty	#tag Property, Flags = &h0		emailPort As Integer = 25	#tag EndProperty	#tag Property, Flags = &h0		emailServer As string	#tag EndProperty	#tag Property, Flags = &h0		emailUsername As string	#tag EndProperty	#tag ViewBehavior		#tag ViewProperty			Name="emailEncrypt"			Group="Behavior"			InitialValue="false"			Type="Boolean"		#tag EndViewProperty		#tag ViewProperty			Name="emailFrom"			Group="Behavior"			Type="string"			EditorType="MultiLineEditor"		#tag EndViewProperty		#tag ViewProperty			Name="emailPassword"			Group="Behavior"			Type="string"			EditorType="MultiLineEditor"		#tag EndViewProperty		#tag ViewProperty			Name="emailPort"			Group="Behavior"			InitialValue="25"			Type="Integer"		#tag EndViewProperty		#tag ViewProperty			Name="emailServer"			Group="Behavior"			Type="string"			EditorType="MultiLineEditor"		#tag EndViewProperty		#tag ViewProperty			Name="emailUsername"			Group="Behavior"			Type="string"			EditorType="MultiLineEditor"		#tag EndViewProperty		#tag ViewProperty			Name="Index"			Visible=true			Group="ID"			Type="Integer"			InheritedFrom="Thread"		#tag EndViewProperty		#tag ViewProperty			Name="Left"			Visible=true			Group="Position"			Type="Integer"			InheritedFrom="Thread"		#tag EndViewProperty		#tag ViewProperty			Name="Name"			Visible=true			Group="ID"			InheritedFrom="Thread"		#tag EndViewProperty		#tag ViewProperty			Name="Priority"			Visible=true			Group="Behavior"			InitialValue="5"			Type="Integer"			InheritedFrom="Thread"		#tag EndViewProperty		#tag ViewProperty			Name="StackSize"			Visible=true			Group="Behavior"			InitialValue="0"			Type="Integer"			InheritedFrom="Thread"		#tag EndViewProperty		#tag ViewProperty			Name="Super"			Visible=true			Group="ID"			InheritedFrom="Thread"		#tag EndViewProperty		#tag ViewProperty			Name="Top"			Visible=true			Group="Position"			Type="Integer"			InheritedFrom="Thread"		#tag EndViewProperty	#tag EndViewBehaviorEnd Class#tag EndClass